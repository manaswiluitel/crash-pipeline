# Name of the GitHub Actions workflow.
name: CI Pipeline

# Controls when the workflow will run.
on:
  # Triggers the workflow on push events for all branches.
  push:
    branches: ["*"]

jobs:
  # --- JOB 1: Build and Validate Code ---
  # This job checks out the code, builds the Go application, and verifies the Python environment.
  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # Specify your Go version

      - name: Build Go Extractor
        # Note: Change 'extractor-go' if your directory has a different name.
        run: |
          cd extractor
          go mod tidy
          go build ./...

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Specify your Python version

      - name: Install Python dependencies
        # Note: Adjust the path if your requirements.txt is not in the root directory.
        run: |
          pip install -r app/requirements.txt
          pip install -r  cleaner/requirements.txt
          pip install -r  transformer/requirements.txt

      - name: Test Python module imports
        # Note: Adjust these import paths to match your project's module structure.
        # For example, if your file is 'transformer/main.py', the import might be 'transformer.main'.
        run: |
          export PYTHONPATH=$PYTHONPATH:./cleaner:./transformer
          python -c "import transformer.transformer"
          python -c "import cleaner.cleaner"

  # --- JOB 2: Docker Compose Validation ---
  # This job runs after 'build' succeeds. It validates the Docker setup.
  docker-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    needs: build # Ensures this job only runs if the 'build' job succeeds.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build key services with docker compose
        # Note: Ensure these service names (extractor, transformer, etc.)
        # match the service names in your docker-compose.yml file.
        run: |
          docker compose -f docker-compose.yml build extractor
          docker compose -f docker-compose.yml build transformer
          docker compose -f docker-compose.yml build cleaner
          docker compose -f docker-compose.yml build app

      - name: Validate docker-compose.yml
        # This command parses the compose file and reports any syntax errors or unresolved variables.
        run: docker compose -f docker-compose.yml config

  # --- JOB 3: Sanity Check Entrypoints ---
  # This job runs after 'docker-validation' and performs lightweight checks on the services.
  sanity-check:
    name: Sanity Check Entrypoints
    runs-on: ubuntu-latest
    needs: docker-validation # Ensures this job only runs if the 'docker-validation' job succeeds.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Extractor --help check
        # This is a light check to see if the Go program can be executed.
        # It assumes a 'main.go' file and that your program handles a --help flag.
        run: |
          cd extractor
          go run main.go --help

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Transformer import test
        # A quick test to confirm the transformer module is importable.
        # Adjust the import path based on your file structure.
        run: |
          python - <<EOF
          try:
              import transformer.transformer
              print("Transformer imported successfully")
          except ImportError as e:
              print(f"Failed to import transformer: {e}")
              exit(1)
          EOF
