jobs:
  deploy:
    name: Deploy Pipeline to Azure
    runs-on: ubuntu-latest
    env:
      AZURE_HOST: ${{ secrets.AZURE_HOST }}
      AZURE_USER: ${{ secrets.AZURE_USER }}
      AZURE_SSH_KEY: ${{ secrets.AZURE_SSH_KEY }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
    steps:
      - name: Set up SSH key
        run: |
          echo "$AZURE_SSH_KEY" > key.pem
          chmod 600 key.pem
          
      - name: Deploy latest version on Azure VM
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no "$AZURE_USER@$AZURE_HOST" "
            set -e
            cd \"$PROJECT_PATH\"
            echo 'üõë Stopping any running services...'
            docker compose down
            echo 'üöö Pulling latest changes from Git...'
            git pull
            echo 'üõ†Ô∏è Building new container images...'
            docker compose build
            echo 'üöÄ Starting all services...'
            docker compose up -d
            echo '‚úÖ Deployment commands finished.'
          "
          
      - name: Smoke test ‚Äì HTTP health checks
        continue-on-error: true
        id: smoke_test
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no "$AZURE_USER@$AZURE_HOST" '
            set -e
            cd "$PROJECT_PATH"
            echo "‚è≥ Waiting for services to stabilize..."
            sleep 30
            echo "üîç Checking Streamlit health..."
            curl -f http://localhost:8501/_stcore/health
            echo "üîç Checking Extractor health..."
            curl -f http://localhost:8001/health
            echo "üîç Checking Transformer health..."
            curl -f http://localhost:8002/health
            echo "üîç Checking Cleaner health..."
            curl -f http://localhost:8003/health
            echo "‚úÖ All HTTP health checks passed."
          '
          
      - name: Debug Docker state on failure
        if: steps.smoke_test.outcome == 'failure'
        run: |
          echo "üî¨ Smoke test failed. Collecting debug information from the VM..."
          ssh -i key.pem -o StrictHostKeyChecking=no "$AZURE_USER@$AZURE_HOST" '
            cd "$PROJECT_PATH"
            echo ""
            echo "--- Docker container status (docker ps -a) ---"
            docker ps -a
            echo ""
            echo "--- Logs for the Streamlit container ---"
            docker compose logs --tail="50" streamlit
            echo ""
            echo "--- Logs for the Extractor container ---"
            docker compose logs --tail="50" extractor
            echo ""
            echo "--- Logs for the Transformer container ---"
            docker compose logs --tail="50" transformer
            echo ""
            echo "--- Logs for the Cleaner container ---"
            docker compose logs --tail="50" cleaner
          '
          exit 1
