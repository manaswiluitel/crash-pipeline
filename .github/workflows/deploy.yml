name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Pipeline to Azure
    runs-on: ubuntu-latest
    env:
      AZURE_HOST: ${{ secrets.AZURE_HOST }}
      AZURE_USER: ${{ secrets.AZURE_USER }}
      AZURE_SSH_KEY: ${{ secrets.AZURE_SSH_KEY }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
    steps:
      - name: Set up SSH key
        run: |
          echo "$AZURE_SSH_KEY" > key.pem
          chmod 600 key.pem
          
      - name: Deploy latest version on Azure VM
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no "$AZURE_USER@$AZURE_HOST" "
            set -e
            cd \"$PROJECT_PATH\"
            echo 'üõë Stopping any running services...'
            docker compose down
            echo 'üöö Pulling latest changes from Git...'
            git pull
            echo 'üõ†Ô∏è Building new container images...'
            docker compose build
            echo 'üöÄ Starting all services...'
            docker compose up -d
            echo '‚úÖ Deployment commands finished.'
          "
          
      - name: Smoke test ‚Äì HTTP health checks
        # REMOVED continue-on-error. This step is now allowed to fail.
        id: smoke_test
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no "$AZURE_USER@$AZURE_HOST" '
            set -e
            cd "$PROJECT_PATH"
            echo "‚è≥ Waiting for services to stabilize..."
            sleep 30
            echo "üîç Checking All Services Health..."
            # This chain will fail if any of the curl commands fail
            curl -f http://localhost:8501/_stcore/health && \
            curl -f http://localhost:8001/health && \
            curl -f http://localhost:8002/health && \
            curl -f http://localhost:8003/health
            echo "‚úÖ All HTTP health checks passed."
          '
